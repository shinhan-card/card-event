# 🕷️ 카드사 크롤러 사용 가이드

## 📌 개선 사항

### ✅ 강화된 크롤링 기능
- **다중 셀렉터 시도**: 각 카드사별로 10개 이상의 CSS 셀렉터 패턴 적용
- **동적 콘텐츠 대응**: Playwright로 JavaScript 렌더링 완벽 지원
- **지능형 텍스트 추출**: 제목, 기간, 본문, 표, 리스트 등 구조화된 추출
- **onclick 이벤트 처리**: JavaScript 링크도 자동 감지 및 처리
- **중복 제거 로직**: 같은 페이지 중복 방지

---

## 🚀 빠른 테스트 방법

### 1. 단일 카드사 테스트 (추천)

```bash
cd c:\Users\82104\Desktop\Cursor\card-event-intelligence
venv\Scripts\activate
python quick_test.py
```

**실행 화면:**
```
빠른 크롤링 테스트
======================================================================

테스트할 카드사를 선택하세요:
  1. 신한카드
  2. 삼성카드
  3. 현대카드
  4. KB국민카드

선택 (1-4): 1
```

**장점:**
- ✅ 브라우저가 보여서 실제 페이지 확인 가능
- ✅ 1개 카드사만 테스트하여 빠른 검증
- ✅ 결과를 텍스트 파일로 저장
- ✅ 디버깅이 쉬움

---

### 2. 사이트 구조 분석 (개발용)

실제 HTML 구조를 확인하고 싶을 때:

```bash
python test_scraper.py
```

**기능:**
- 페이지 HTML을 `html_신한카드.html` 형식으로 저장
- 스크린샷 저장 (`screenshot_신한카드.png`)
- 이벤트 관련 링크 자동 탐지 및 출력

---

### 3. 전체 시스템 테스트

```bash
python main.py --once
```

4개 카드사 모두 크롤링 → AI 분석 → DB 저장

---

## 🔧 CSS 셀렉터 커스터마이징

### 카드사별 셀렉터 위치

`scraper.py` 파일의 `extract_event_list_urls` 함수:

```python
if company == "신한카드":
    selectors = [
        'a[href*="eventDetail"]',      # 추가
        'a[href*="/event/"]',           # 추가
        '.event-list a',                # 추가
        'li.event-item a',              # 추가
    ]
```

### 셀렉터 찾는 방법

1. **브라우저 개발자 도구 사용**
   - `F12` → Elements 탭
   - 이벤트 링크에 마우스 오버
   - 우클릭 → Copy → Copy selector

2. **quick_test.py로 확인**
   - 브라우저가 열리면 직접 페이지 확인
   - 어떤 셀렉터가 작동했는지 로그 출력

3. **test_scraper.py로 HTML 저장**
   - 저장된 HTML 파일을 VSCode로 열기
   - Ctrl+F로 "event" 검색

---

## 📊 실행 결과 예시

### 성공 케이스

```
[신한카드] 이벤트 목록 수집 중...
  [DEBUG] a[href*="eventDetail"]: 12개 발견
  [DEBUG] .event-list a: 8개 발견
✅ [신한카드] 총 15개 이벤트 URL 발견
  샘플 URL: https://www.shinhancard.com/event/detail?id=123...

📄 상세 페이지 분석 중: https://www.shinhancard.com/event/...
  [INFO] 추출된 텍스트 길이: 2847자
```

### 실패 케이스 (URL 0개)

```
[삼성카드] 이벤트 목록 수집 중...
  [DEBUG] a[href*="eventDetail"]: 0개 발견
  [DEBUG] a[href*="benefit/event"]: 0개 발견
✅ [삼성카드] 총 0개 이벤트 URL 발견

⚠️ 해결 방법:
1. test_scraper.py 실행하여 HTML 구조 확인
2. 실제 사이트의 링크 패턴 파악
3. scraper.py의 selectors 배열에 추가
```

---

## 🎯 자주 발생하는 문제 & 해결

### 1. "0개 이벤트 URL 발견"

**원인:** CSS 셀렉터가 실제 사이트 구조와 맞지 않음

**해결:**
```bash
# 1단계: 사이트 분석
python test_scraper.py
# 1번 선택 (신한카드)

# 2단계: html_신한카드.html 파일 열어서 구조 확인
# 3단계: scraper.py의 selectors 수정
```

### 2. "추출된 텍스트가 너무 짧음"

**원인:** 본문 셀렉터가 정확하지 않음

**해결:**
`scraper.py`의 `extract_event_detail` 함수에서 `content_selectors` 배열에 패턴 추가:

```python
content_selectors = [
    'div.event-content',     # 기본
    'div.my-custom-class',   # 추가
    'article.event-detail',  # 추가
]
```

### 3. 인코딩 오류 (이모지 출력 실패)

**해결:** 이미 수정되었습니다. 
- UTF-8 인코딩 설정 완료
- 이모지 대신 [OK], [ERROR] 등 텍스트 사용

### 4. Playwright 브라우저 오류

```bash
# Chromium 재설치
venv\Scripts\playwright.exe install chromium
```

---

## 💡 고급 활용 팁

### 1. 특정 카드사만 크롤링

`main.py` 수정:
```python
# 42번째 줄 근처
self.scraper.card_companies = {
    "신한카드": os.getenv("SHINHAN_EVENT_URL"),
    # 다른 카드사 주석 처리
}
```

### 2. 크롤링 속도 조절

`scraper.py`의 `random_delay` 호출 부분:
```python
await self.random_delay(2, 4)  # 2~4초 대기
# → 더 빠르게: (1, 2)
# → 더 느리게: (5, 10)
```

### 3. 수집 개수 제한

`scraper.py`의 `extract_event_list_urls`:
```python
event_urls = list(dict.fromkeys(event_urls))[:20]  # 최대 20개
# → 더 많이: [:50]
# → 더 적게: [:10]
```

### 4. headless 모드로 실행

`quick_test.py`:
```python
await scraper.init_browser(headless=True)  # False → True
```

---

## 📝 크롤링 결과 활용

### 1. 텍스트 파일 확인

```
test_result_신한카드.txt      # 단일 이벤트
test_result_신한카드_all.txt  # 전체 이벤트
```

### 2. AI 분석 실행

```bash
python main.py --once
```

Gemini AI가 자동으로 다음 정보 추출:
- 카테고리 (쇼핑/여행/식음료 등)
- 혜택 유형 (할인/캐시백/포인트)
- 혜택 금액
- 참여 조건
- 위협도 (High/Mid/Low)

### 3. 대시보드에서 확인

```bash
python app.py
# http://localhost:8000 접속
```

---

## 🔍 디버깅 팁

### 로그 레벨 높이기

`scraper.py`에 디버그 출력 추가:
```python
print(f"  [DEBUG] 현재 URL: {await self.page.url}")
print(f"  [DEBUG] 페이지 제목: {await self.page.title()}")
```

### 브라우저 멈춤 현상

크롤링 중 브라우저가 멈추면:
```python
# timeout 늘리기
await self.page.goto(url, timeout=60000)  # 30000 → 60000
```

### 특정 요소가 안 보이면

JavaScript 렌더링 대기:
```python
await self.page.wait_for_selector('.event-list', timeout=10000)
await self.random_delay(2, 3)
```

---

## 📞 문제 해결이 안 될 때

1. **HTML 파일 공유**: `html_카드사명.html` 파일 확인
2. **스크린샷 확인**: 실제로 어떤 페이지가 로드되었는지 확인
3. **에러 메시지 복사**: 정확한 오류 내용 파악

---

## ✅ 체크리스트

크롤링 시작 전:
- [ ] `.env` 파일에 API 키 설정
- [ ] 가상환경 활성화 (`venv\Scripts\activate`)
- [ ] Playwright 브라우저 설치 완료
- [ ] 테스트 카드사 1개로 먼저 검증

크롤링 성공 기준:
- [ ] 이벤트 URL 5개 이상 발견
- [ ] 상세 페이지 텍스트 500자 이상 추출
- [ ] 텍스트에 이벤트 제목/기간 포함
- [ ] AI 분석 시 JSON 파싱 성공

---

**🎉 성공적인 크롤링을 기원합니다!**
